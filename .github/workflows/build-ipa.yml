name: Build RHVoice IPA

on:
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number'
        required: true
        default: '1'
      platform:
        description: 'Target platform'
        required: true
        default: 'iOS'
        type: choice
        options:
          - iOS
          - macOS
          - Both
      bundle_languages:
        description: 'Languages to bundle (comma-separated folder names from Core/Core/data/languages/)'
        required: false
        default: 'Russian,English'
      bundle_voices:
        description: 'Voices to bundle (comma-separated folder names from Core/Core/data/voices/)'
        required: false
        default: 'anna,aleksandr'

jobs:
  build:
    runs-on: macos-15
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Patch package URL to use packages-1.16.json
        run: |
          sed -i '' 's|https://s2.nonroutine.com/apple.json|https://rhvoice.org/download/packages-1.16.json|' Core/Package.swift
          sed -i '' 's|packages-1.18.json|packages-1.16.json|' Core/Core/src/pkg/package_client.cpp
          echo "Verifying Package.swift patch:"
          grep PKG_DIR_URL Core/Package.swift

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Build and archive (iOS)
        if: inputs.platform == 'iOS' || inputs.platform == 'Both'
        env:
          BUILD_NUMBER: ${{ inputs.build_number }}
        run: |
          xcodebuild clean archive \
            -project RHVoice.xcodeproj \
            -configuration "Release" \
            -scheme RHVoiceApp \
            -archivePath "BuildOutput/RHVoiceAppiOS.xcarchive" \
            -destination "generic/platform=iOS" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS=""

      - name: Bundle voice data into extension (iOS)
        if: inputs.platform == 'iOS' || inputs.platform == 'Both'
        run: |
          APP_PATH=$(ls -d BuildOutput/RHVoiceAppiOS.xcarchive/Products/Applications/*.app)
          APPEX_PATH=$(ls -d "$APP_PATH"/PlugIns/*.appex)
          echo "App path: $APP_PATH"
          echo "Extension path: $APPEX_PATH"

          VOICE_DATA_DIR="$APPEX_PATH/RHVoiceData"
          mkdir -p "$VOICE_DATA_DIR/languages"
          mkdir -p "$VOICE_DATA_DIR/voices"

          IFS=',' read -ra LANGS <<< "${{ inputs.bundle_languages }}"
          for lang in "${LANGS[@]}"; do
            lang=$(echo "$lang" | xargs)
            SRC="Core/Core/data/languages/$lang"
            if [ -d "$SRC" ]; then
              echo "Bundling language: $lang"
              cp -r "$SRC" "$VOICE_DATA_DIR/languages/"
            else
              echo "WARNING: Language folder not found: $SRC"
            fi
          done

          IFS=',' read -ra VOICES <<< "${{ inputs.bundle_voices }}"
          for voice in "${VOICES[@]}"; do
            voice=$(echo "$voice" | xargs)
            SRC="Core/Core/data/voices/$voice"
            if [ -d "$SRC" ]; then
              echo "Bundling voice: $voice"
              cp -r "$SRC" "$VOICE_DATA_DIR/voices/"
            else
              echo "WARNING: Voice folder not found: $SRC"
            fi
          done

          echo "Bundled voice data contents:"
          ls -R "$VOICE_DATA_DIR" | head -40
          echo "Total size:"
          du -sh "$VOICE_DATA_DIR"

          MAIN_VOICE_DATA_DIR="$APP_PATH/RHVoiceData"
          cp -r "$VOICE_DATA_DIR" "$MAIN_VOICE_DATA_DIR"
          echo "Also copied voice data to main app bundle."

      - name: Create unsigned IPA (iOS)
        if: inputs.platform == 'iOS' || inputs.platform == 'Both'
        run: |
          mkdir -p BuildOutput/Payload
          cp -r BuildOutput/RHVoiceAppiOS.xcarchive/Products/Applications/*.app BuildOutput/Payload/
          cd BuildOutput
          zip -r RHVoice-iOS-unsigned.ipa Payload
          rm -rf Payload

      - name: Build and archive (macOS)
        if: inputs.platform == 'macOS' || inputs.platform == 'Both'
        env:
          BUILD_NUMBER: ${{ inputs.build_number }}
        run: |
          xcodebuild clean archive \
            -project RHVoice.xcodeproj \
            -configuration "Release" \
            -scheme RHVoiceApp \
            -archivePath "BuildOutput/RHVoiceAppmacOS.xcarchive" \
            -destination "generic/platform=macOS" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS=""

      - name: Package macOS app
        if: inputs.platform == 'macOS' || inputs.platform == 'Both'
        run: |
          cd BuildOutput
          zip -r -y RHVoice-macOS.zip RHVoiceAppmacOS.xcarchive/Products/Applications/*.app

      - name: Upload iOS IPA
        if: inputs.platform == 'iOS' || inputs.platform == 'Both'
        uses: actions/upload-artifact@v4
        with:
          name: RHVoice-iOS-unsigned-ipa
          path: BuildOutput/RHVoice-iOS-unsigned.ipa

      - name: Upload iOS xcarchive
        if: inputs.platform == 'iOS' || inputs.platform == 'Both'
        uses: actions/upload-artifact@v4
        with:
          name: RHVoice-iOS-xcarchive
          path: BuildOutput/RHVoiceAppiOS.xcarchive

      - name: Upload macOS app
        if: inputs.platform == 'macOS' || inputs.platform == 'Both'
        uses: actions/upload-artifact@v4
        with:
          name: RHVoice-macOS-app
          path: BuildOutput/RHVoice-macOS.zip
